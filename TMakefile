param CC = gcc
param CFLAGS = "-g -O2 -ansi -Wall"

param MAKE_C_EXT = "jimtcl/jimsh jimtcl/make-c-ext.tcl"

param JIMFLAGS = [options { --disable-lineedit
                            --math
                            --disable-docs
                            --without-ext="eventloop history load syslog"
                            --with-ext="binary tclprefix"
                          }]

proc cc args {
	global CC CFLAGS

	exec $CC {*}$CFLAGS {*}$args
}

proc make-c-ext {tclfile cfile} {
	global MAKE_C_EXT

	exec -flags @ echo "#define JIM_EMBEDDED" > $cfile
	exec {*}$MAKE_C_EXT $tclfile >> $cfile
}

rule all {tmake}

rule jim {} {
	global JIMFLAGS

	cd jimtcl
	exec ./configure {*}$JIMFLAGS
	exec make
	cd .. 
}

set H_SRC "tm_crypto.h tm_target.h tm_core_cmds.h tm_ext_cmds.h"
set C_SRC "tmake.c tm_crypto.c tm_target.c tm_core_cmds.c tm_ext_cmds.c"

rule tm_ext_cmds.c {tm_ext_cmds.tcl} {
	make-c-ext $INPUTS $TARGET
}

rule tmake {jim $C_SRC $H_SRC} {
	global C_SRC

	cc -o $TARGET -Ijimtcl {*}$C_SRC jimtcl/libjim.a -lm
}

