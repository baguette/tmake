param CC = gcc
param CFLAGS = "-g -O2 -ansi -Wall"

param MAKE_C_EXT = "jimtcl/jimsh jimtcl/make-c-ext.tcl"

proc options {str} {
	set OPTIONS [split $str "\n"]
	set TRIMOPTS {}
	foreach OPT $OPTIONS {
		set trim [string trim $OPT]
		if {[string length $trim]} {
			lappend TRIMOPTS $trim
		}
	}
	return $TRIMOPTS
}
param JIMFLAGS = [options { --disable-lineedit
                            --math
                            --disable-docs
                            --without-ext="eventloop history load syslog"
                            --with-ext="binary tclprefix"
                          }]

proc cc args {
	global CC CFLAGS

	puts "$CC $CFLAGS $args"
	puts [exec $CC {*}$CFLAGS {*}$args]
}

proc make-c-ext {tclfile cfile} {
	global MAKE_C_EXT

	puts "$MAKE_C_EXT $tclfile > $cfile"
	exec echo "#define JIM_EMBEDDED" > $cfile
	exec {*}$MAKE_C_EXT $tclfile >> $cfile
}

rule all {tmake}

rule jim {} {
	global JIMFLAGS

	puts "cd jimtcl"
	cd jimtcl

	puts "./configure $JIMFLAGS"
	puts [exec ./configure {*}$JIMFLAGS]

	puts "make"
	puts [exec make]

	puts "cd .."
	cd .. 
}

set C_SRC "tmake.c tm_crypto.c tm_target.c tm_core_cmds.c tm_ext_cmds.c"

rule tm_ext_cmds.c {tm_ext_cmds.tcl} {
	make-c-ext $INPUTS $TARGET
}

rule tmake {jim $C_SRC} {
	global C_SRC

	cc -o tmake -Ijimtcl {*}$C_SRC jimtcl/libjim.a -lm
}

